# Story 10.1: Implement Final Audit Team Deployment Refactor

## Status: In Progress

## Story
**As a** developer,
**I want** to implement the audit team's final recommendations for the server and client,
**so that** the application is robust, deployable, and correctly serves API and static assets in production.

## Problem
Previous fixes were incomplete. The root causes for deployment failure are a missing `trust proxy` setting, incorrect API route ordering, and a client that does not guard against non-JSON responses.

## Acceptance Criteria:
1. `server.js` must be refactored to include `app.set('trust proxy', 1)`.
2. `server.js` must have a hardened SPA fallback route that explicitly ignores API paths.
3. The `/api/channels` and `/auth/status` routes must be correctly defined before the fallback route.
4. `client/src/api.js` must be updated to default to same-origin, send `Accept: application/json` headers, and validate the response `Content-Type` before parsing.
5. The application must deploy and run on Railway without errors.

## Tasks / Subtasks

- [ ] **Task 1: Refactor `server.js`** (AC: 1, 2, 3)
    - [ ] Overwrite `server.js` with a new version that correctly orders all middleware and routes as specified by the audit team.

- [ ] **Task 2: Refactor `client/src/api.js`** (AC: 4)
    - [ ] Overwrite `client/src/api.js` with the new hardened version.

- [ ] **Task 3: Verify `Channels.jsx`**
    - [ ] Confirm that `client/src/pages/Channels.jsx` uses the `get` helper from the new `api.js`.

## Dev Notes
*   This story implements the definitive fixes from the audit team, which should resolve all outstanding deployment issues.
