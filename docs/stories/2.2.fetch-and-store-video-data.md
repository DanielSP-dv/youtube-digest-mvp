# Story 2.2: Fetch and Store Video Data

## Status: Review

## Story
**As a** developer,
**I want** to create a backend process that fetches video metadata and transcripts for user-selected channels,
**so that** the data is available for summarization.

## Acceptance Criteria:
1.  A backend endpoint (e.g., `/api/refresh-videos`) is created to trigger the process for the logged-in user.
2.  The process iterates through the user's `selected_channels` from the database.
3.  For each channel, it fetches the latest videos (e.g., the 5 most recent).
4.  For each new video, it fetches the transcript.
5.  The video's `video_id`, `channel_id`, and `title` are saved to the `video_summaries` table, but only if the `video_id` doesn't already exist. This acts as a basic cache to prevent re-processing.

## Tasks / Subtasks

- [x] **Task 1: Create Backend Endpoint for Refreshing Video Data** (AC: 1)
    - [ ] In `server.js`, create a new authenticated GET endpoint at `/api/refresh-videos`.
    - [ ] This endpoint should initiate the video fetching and storing process.

- [x] **Task 2: Fetch Selected Channels from Database** (AC: 2)
    - [ ] In the `/api/refresh-videos` endpoint, retrieve the `selected_channels` for the current user from the database using `db.query`.

- [x] **Task 3: Fetch Latest Videos from YouTube Data API** (AC: 3)
    - [ ] For each selected channel, use `services/youtube.js` to fetch the latest videos (e.g., 5 most recent) from the YouTube Data API.
    - [ ] Ensure the `access_token` from the user's session is used for authentication.

- [x] **Task 4: Fetch Video Transcripts** (AC: 4)
    - [ ] For each new video, implement logic to fetch its transcript. This will likely involve a new function in `services/transcript.js`.
    - [ ] Handle cases where transcripts might not be available.

- [x] **Task 5: Save Video Data to `video_summaries` Table** (AC: 5)
    - [ ] Save the video's `video_id`, `channel_id`, and `title` to the `video_summaries` table.
    - [ ] Implement a check to only insert if the `video_id` does not already exist in the table.

## Dev Notes

*   **Architecture & Tech Stack**:
    *   **Language**: JavaScript (ES6+) [Source: `docs/architecture/3-tech-stack.md`]
    *   **Backend Framework**: Express.js (~4.18.2) for building the REST API. [Source: `docs/architecture/3-tech-stack.md`]
    *   **Database**: SQLite for local development, PostgreSQL for deployment. [Source: `docs/architecture/3-tech-stack.md`]
    *   **Database Interaction**: Raw SQL (`sqlite3` package). [Source: `docs/architecture/3-tech-stack.md`]
    *   **Authentication**: Passport.js (~0.6.0) for Google OAuth. [Source: `docs/architecture/3-tech-stack.md`]
    *   **External APIs**: YouTube Data API (for fetching video data), SearchAPI (or similar for transcripts). [Source: `docs/architecture/6-external-apis.md`]

*   **Data Models**:
    *   This story interacts with `selected_channels` and `video_summaries` tables.
    *   **`selected_channels`**: `user_id` (FK), `channel_id`, `channel_name`, `channel_thumbnail`, `created_at`. [Source: `docs/architecture/4-data-models.md`]
    *   **`video_summaries`**: `id`, `video_id`, `channel_id`, `title`, `thumbnail`, `published_at`, `summary`, `created_at`. [Source: `docs/architecture/4-data-models.md`]
    *   **Database Schema**: Refer to `docs/architecture/7-database-schema.md` for DDL.

*   **API Specifications**:
    *   Backend will expose simple REST API endpoints. [Source: `docs/prd.md#technical-assumptions`]
    *   New endpoint: `/api/refresh-videos` (GET, authenticated).

*   **File Locations**:
    *   Backend logic will primarily be in `server.js`. [Source: `docs/architecture/8-source-tree.md`]
    *   Database helpers in `db.js`. [Source: `docs/architecture/8-source-tree.md`]
    *   YouTube API interactions in `services/youtube.js`. [Source: `docs/architecture/8-source-tree.md`]
    *   Transcript fetching in `services/transcript.js`. [Source: `docs/architecture/8-source-tree.md`]

*   **Coding Standards**:
    *   **Code Style**: JavaScript Standard (2 spaces indentation, no semicolons, async/await). [Source: `docs/architecture/10-coding-standards.md`]
    *   **Error Handling**: Every async function must have try/catch blocks. [Source: `docs/architecture/10-coding-standards.md`]
    *   **Naming Conventions**: `camelCase` for variables/functions, `UPPER_SNAKE_CASE` for constants, `PascalCase` for React components, `lowercase-with-dashes` or `camelCase` for files. [Source: `docs/architecture/10-coding-standards.md`]
    *   **Comment Requirements**: Every non-obvious function needs a comment explaining its purpose. [Source: `docs/architecture/10-coding-standards.md`]

*   **Testing**:
    *   Manual Testing Only for MVP. [Source: `docs/architecture/11-testing-strategy.md`]
    *   Validation will be performed by testing each feature locally before committing and after deployment. [Source: `docs/architecture/11-testing-strategy.md`]

*   **Previous Story Insights (from Story 2.1):**
    *   Manual `.env` parsing in `server.js` is a custom implementation; ensure all required environment variables are at the top of `.env` file.
    *   `refresh_token` handling: Ensure `access_token` and `refresh_token` are correctly updated for existing users during login to prevent 401 errors from YouTube API. The `updateUserTokens` function in `db.js` and its usage in `server.js` are critical.
    *   Hardcoded `http://localhost:5001` in `client/src/App.js` for auth routes is a known simplification for MVP.

*   **Environment Variables for this Story:**
    *   `YOUTUBE_API_KEY`: Required for fetching video data from YouTube.
    *   `SEARCHAPI_KEY`: Required for fetching video transcripts (if using SearchAPI as a fallback).

## Testing:

*   **Manual Verification Steps:**
    1.  **Verify Endpoint Creation (AC1):**
        *   Ensure the backend server is running.
        *   Using a tool like Postman or `curl`, make an authenticated GET request to `/api/refresh-videos`.
        *   Expected: A successful response (e.g., 200 OK) and a confirmation message indicating the process has been triggered.
        *   Expected: If not authenticated, verify a 401 Unauthorized response.
    2.  **Verify Channel Iteration (AC2):**
        *   Ensure you have selected channels in Story 2.1.
        *   Trigger the `/api/refresh-videos` endpoint.
        *   Monitor backend logs to confirm that the process iterates through your selected channels.
    3.  **Verify Latest Video Fetching (AC3):**
        *   For each selected channel, verify that the latest 5 videos are fetched from the YouTube Data API. This can be observed through backend logs or by inspecting the `video_summaries` table after the process runs.
    4.  **Verify Transcript Fetching (AC4):**
        *   For each new video, verify that a transcript is attempted to be fetched.
        *   Verify that the system handles cases where transcripts are not available (e.g., no crash, appropriate logging).
    5.  **Verify Data Saving and Caching (AC5):**
        *   After triggering the refresh, query the `video_summaries` table.
        *   Verify that new videos (`video_id`, `channel_id`, `title`) are inserted.
        *   Trigger the refresh again immediately. Verify that existing videos are *not* re-inserted (i.e., no duplicate `video_id` entries).

## Dev Agent Record

### Agent Model Used

Gemini

### Completion Notes List

- Implemented Task 1: Created authenticated GET endpoint `/api/refresh-videos` in `server.js`.
- Implemented Task 2: Fetched selected channels from the database in `server.js`.
- Implemented Task 3: Fetched latest videos from YouTube Data API using `services/youtube.js`.
- Implemented Task 4: Fetched video transcripts using `youtube-transcript` library with SearchAPI fallback in `services/transcript.js`.
- Implemented Task 5: Saved video data to `video_summaries` table in `server.js` with existence check.
- Fixed `TypeError: Assignment to constant variable.` in `server.js`.
- Added `axios` and `youtube-transcript` dependencies to `package.json`.
- Added `video_summaries` table creation to `db.js`.

### File List

- `/Users/D/FINALMVP/server.js`
- `/Users/D/FINALMVP/services/youtube.js`
- `/Users/D/FINALMVP/services/transcript.js`
- `/Users/D/FINALMVP/db.js`
- `/Users/D/FINALMVP/package.json`

### Change Log:
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-05 | 1.0 | Initial draft of Story 2.2 | Bob (Scrum Master) |
| 2025-09-05 | 1.1 | Updated with explicit environment variables and manual testing steps. Status changed to Review. | Bob (Scrum Master) |
| 2025-09-05 | 1.2 | Implemented all tasks for Story 2.2. | James (Full Stack Developer) |

## QA Results

### Review Date: 2025-09-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Re-validated the full data flow for Story 2.2. The `sqlite3` query confirms that the backend process correctly fetches video data and populates the `video_summaries` table. The outcome matches the acceptance criteria. The story remains a PASS.

### Refactoring Performed
None required.

### Compliance Check
- All ACs Met: ✓

### Gate Status
Gate: PASS → docs/qa/gates/2.2.fetch-and-store-video-data.yml

### Recommended Status
✓ Ready for Done

