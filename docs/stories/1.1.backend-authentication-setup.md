# Story 1.1: Backend & Authentication Setup

## Status: Done

## Story
**As a** developer,
**I want** to set up a basic Express server and configure Google OAuth using Passport.js,
**so that** the application has a secure authentication entry point.

## Acceptance Criteria:
1. When the backend session is valid, the header shows the user email.
2. When no session, the header shows Login with Google.
3. Clicking Login with Google navigates to the backend login route.
4. Clicking Logout calls the backend logout route and returns to the client root.
5. The app must not render protected pages until the auth status request completes. A loading view is acceptable.

## Tasks / Subtasks

- [ ] **Task 1: Set up Express Server** (AC: 1)
    - [ ] Initialize `npm` in the root directory and install `express`.
    - [ ] Create `server.js` and set up a basic Express app that listens on `process.env.PORT`.
    - [ ] Add a basic root route `/` that sends a "Hello World" response.

- [x] **Task 1: Set up Express Server** (AC: 1)
    - [x] Initialize `npm` in the root directory and install `express`.
    - [x] Create `server.js` and set up a basic Express app that listens on `process.env.PORT`.
    - [x] Add a basic root route `/` that sends a "Hello World" response.

- [x] **Task 2: Configure Passport.js for Google OAuth** (AC: 2, 3, 4)
    - [x] Install `passport`, `passport-google-oauth20`, and `express-session`.
    - [x] In `server.js`, configure `express-session` with a `SESSION_SECRET` from environment variables.
    - [x] In `server.js` (or a separate `auth.js` module if preferred), configure the Passport Google OAuth2 strategy with `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`.
    - [x] The Passport callback must handle finding or creating a user in the database.
    - [x] Set up the `/auth/google` and `/auth/google/callback` routes in `server.js`.

- [x] **Task 3: Integrate with Database** (AC: 5)
    - [x] In `db.js`, create and export a function to find a user by `google_id`.
    - [x] In `db.js`, create and export a function to create a new user.
    - [x] In the Passport callback, use the `db.js` functions to save the user's profile (`google_id`, `email`, `name`, `access_token`, `refresh_token`) to the `users` table.

- [x] **Task 4: Create API for User Session**
    - [x] Create a `/api/current_user` endpoint that returns the currently logged-in user's data from the session, or `null` if not authenticated.
    - [x] Create a `/auth/logout` endpoint that destroys the session and redirects to the root.

- [ ] **Task 3: Integrate with Database** (AC: 5)
    - [ ] In `db.js`, create and export a function to find a user by `google_id`.
    - [ ] In `db.js`, create and export a function to create a new user.
    - [ ] In the Passport callback, use the `db.js` functions to save the user's profile (`google_id`, `email`, `name`, `access_token`, `refresh_token`) to the `users` table.

- [ ] **Task 4: Create API for User Session**
    - [ ] Create a `/api/current_user` endpoint that returns the currently logged-in user's data from the session, or `null` if not authenticated.
    - [ ] Create a `/auth/logout` endpoint that destroys the session and redirects to the root.

## Test Notes:

1.  Unit test for the `useAuth` hook with a mocked fetch to auth status.
2.  Integration test that stubs auth status to both authenticated and not authenticated.
3.  Playwright test update. The Welcome back selector in the previous failing test must align with the current UI.

Gate decision can move to Pass once the above tests are green.

## Dev Notes

*   **Architecture & Tech Stack**:
    *   This story initiates the **Monolithic Architecture** with a simple Express server. [Source: `docs/architecture/2-high-level-architecture.md`]
    *   **Authentication**: Use **Passport.js** (`~0.6.0`) with the `passport-google-oauth20` strategy. [Source: `docs/architecture/3-tech-stack.md`]
    *   **Database Interaction**: Use raw SQL via the `pg` or `sqlite3` npm package. All database logic should be in `db.js`. [Source: `docs/architecture/3-tech-stack.md`]

*   **File Locations**:
    *   All server and auth logic will be in `server.js` as per the simplified source tree. [Source: `docs/architecture/8-source-tree.md`]
    *   Database helpers will be in `db.js`. [Source: `docs/architecture/8-source-tree.md`]

*   **Security**:
    *   All secrets (`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `SESSION_SECRET`, `DATABASE_URL`) **must** be loaded from environment variables and never hardcoded. [Source: `docs/architecture/12-security-considerations.md`]

*   **Testing**: 
    *   Per the testing strategy, all validation for this story will be **manual**. No automated tests are required. [Source: `docs/architecture/11-testing-strategy.md`]

## Change Log:
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-02 | 1.0 | Initial draft of Story 1.1 | Bob (Scrum Master) |