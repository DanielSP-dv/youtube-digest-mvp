# Story 6.2: Implement Critical Railway Deployment Hotfixes

## Status: In Progress

## Story
**As a** developer,
**I want** to apply critical hotfixes to the database schema, server configuration, and build process,
**so that** the application can be deployed and run successfully on Railway.

## Problem
A code review identified several critical blockers preventing a successful deployment. These include a database schema mismatch, incorrect Node.js version, hardcoded client URLs, missing production server settings, and an ephemeral database path.

## Acceptance Criteria:
1. The `db.js` file is updated with the correct schema for `video_summaries` (including `user_id`), enables foreign keys, and uses an environment variable for the database path.
2. The `nixpacks.toml` file is updated to use Node.js 20 and a safer `npm install` command for the client.
3. The `client/src/api.js` file is updated to use relative URLs, preventing it from calling `localhost` in production.
4. The `server.js` file is configured to trust proxies and use production-safe secure cookie settings.
5. After the fixes are applied, the application must be deployable and fully functional on Railway.

## Tasks / Subtasks

- [x] **Task 1: Patch `db.js`** (AC: 1)
    - [x] Update the `video_summaries` CREATE TABLE statement to include `user_id`.
    - [x] Add `CREATE UNIQUE INDEX` for `(user_id, video_id)`.
    - [x] Enable foreign keys with `PRAGMA foreign_keys = ON`.
    - [x] Modify the database path to be configurable via `process.env.DATABASE_URL`.

- [x] **Task 2: Patch `nixpacks.toml`** (AC: 2)
    - [x] Change `nixPkgs` to `["nodejs_20", "npm-10_x"]`.
    - [x] Change the client install command to `cd client && npm install`.

- [x] **Task 3: Patch `client/src/api.js`** (AC: 3)
    - [x] Change the `API_BASE_URL` declaration to default to an empty string `''`.

- [x] **Task 4: Patch `server.js`** (AC: 4)
    - [x] Add `app.set('trust proxy', 1)`.
    - [x] Update the `session` middleware to set `cookie.sameSite` to `'none'` in production.

## Dev Notes
*   This story implements a series of critical hotfixes identified in a code review to enable a successful Railway deployment.
*   The user must still set the `DATABASE_URL` and `REACT_APP_API_URL` environment variables in the Railway dashboard.
