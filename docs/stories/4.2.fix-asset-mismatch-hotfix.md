# Story 4.2: Fix Asset Mismatch Hotfix

## Status: Review

## Story
**As a** developer,
**I want** the deployed application to reliably serve the correct frontend assets,
**so that** users are not served a broken UI due to build cache issues.

## Problem
The current deployment process is susceptible to a mismatch between the `index.html` file and the hashed JavaScript/CSS assets it references. A stale `index.html` can be served, pointing to old, non-existent asset files, which breaks the application for end-users.

## Acceptance Criteria:
1. The `server.js` file must dynamically inject the correct, current asset paths from `asset-manifest.json` into `index.html` before serving it.
2. The production static file server must be hardened to serve hashed assets with a long-term cache policy and never fall through to the SPA handler.
3. The production server must serve `index.html` and all other HTML routes with a `Cache-Control: no-store` header to prevent browser or CDN caching of the stale file.
4. The `nixpacks.toml` build process must be updated to clear any old build artifacts (`client/build`, cache) before starting a new build to ensure a clean state.
5. The application must include a server-start integrity check that warns if the assets listed in the manifest do not exist on disk.

## Tasks / Subtasks

- [x] **Task 1: Implement Server-Side Asset Rewrite** (AC: 1, 2, 3)
    - [x] In `server.js`, add a function `renderIndexWithFreshAssets` that reads `index.html` and `asset-manifest.json`.
    - [x] The function will use regex to replace the placeholder script/CSS tags in the HTML with the actual filenames from the manifest.
    - [x] Update the `app.get('*')` and root `/` routes to use this new function and set the `Cache-Control: no-store` header.
    - [x] Implement the hardened `express.static` route for the `/static` directory with an immutable cache policy.

- [x] **Task 2: Implement Build Integrity Guard** (AC: 5)
    - [x] In `server.js`, add a try/catch block at startup that reads `asset-manifest.json` and verifies that the `main.js` and `main.css` files exist at their specified paths.
    - [x] Log a clear error to the console if a file is missing.

- [x] **Task 3: Update `nixpacks.toml` for Clean Builds** (AC: 4)
    - [x] Modify the `[phases.build]` command in `nixpacks.toml`.
    - [x] Add a command to `rm -rf client/build` to ensure a clean slate.
    - [x] Add `ls` and `cat` commands for the build directory and manifest to improve build log debugging.
    - [x] Ensure `[start].cmd` is `node server.js` and `NODE_ENV` is set to `production`.

- [ ] **Task 4: Deploy and Verify** (AC: 4)
    - [ ] Commit and push changes.
    - [ ] Trigger a new deployment on Railway.
    - [ ] Verify the live URL loads the application.

## Dev Notes

*   **Architecture & Tech Stack**:
    *   This story modifies the existing Express server and Nixpacks configuration. It introduces a dynamic HTML serving pattern to increase deployment resilience. [Source: `docs/architecture/2-high-level-architecture.md`]
*   **File Locations**:
    *   All server-side changes will be in `server.js`. [Source: `docs/architecture/8-source-tree.md`]
    *   Build process changes will be in `nixpacks.toml`.
*   **Security & Performance**:
    *   The changes to caching headers are critical for ensuring users get the latest version of the application shell while still benefiting from long-term caching of immutable assets. [Source: `docs/architecture/12-security-considerations.md`]
*   **Testing**:
    *   Manual verification is required. The user has provided a detailed 5-step verification plan involving `curl` and browser inspection. [Source: `docs/architecture/11-testing-strategy.md`]

## Dev Agent Record

### Agent Model Used
Gemini

### Completion Notes List
- Implemented a manifest-driven asset rewrite in `server.js` to prevent stale asset errors.
- Added a build integrity guard to `server.js` to check for missing assets on startup.
- Hardened the static file and SPA routes in `server.js` with correct caching headers.
- Updated `nixpacks.toml` to perform clean builds and improve debug logging.

### File List
- `/Users/D/FINALMVP/server.js`
- `/Users/D/FINALMVP/nixpacks.toml`

## Change Log:
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-15 | 1.0 | Initial draft of Story 4.2 | Bob (Scrum Master) |
| 2025-09-15 | 2.0 | Implemented hotfix for asset mismatch | James (Full Stack Developer) |